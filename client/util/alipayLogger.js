"use strict";Date.now=Date.now||function(){return new Date().getTime()};var SEQUENCE=Date.now(),noop=function(){},getCwarn=function(){var t="object"==typeof console?console.warn:noop;try{var e={warn:t};e.warn.call(e)}catch(n){return noop}return t},util={noop:noop,warn:getCwarn(),createObject:function(t){if(Object.create){return Object.create(t)}var e=function(){};return e.prototype=t,new e()},each:function(t,e){var n=0,r=t.length;if(this.T(t,"Array")){for(;n<r&&!1!==e.call(t[n],t[n],n);n++){}}else{for(n in t){if(!1===e.call(t[n],t[n],n)){break}}}return t},safetyCall:function(t,e,n){if("function"!=typeof t){return n}try{return t.apply(this,e)}catch(r){return n}},T:function(t,e){var n=Object.prototype.toString.call(t).substring(8).replace("]","");return e?n===e:n},J:function(t){if(!t||"string"!=typeof t){return t}var e=null;try{e=JSON.parse(t)}catch(n){}return e},pick:function(t){return 1===t||1===Math.ceil(Math.random()*t)},verifyConfig:function(t){if("sample" in t){var e=t.sample,n=e;e&&/^\d+(\.\d+)?%$/.test(e)&&(n=parseInt(100/parseFloat(e))),0<n&&1>n&&(n=parseInt(1/n)),n>=1&&n<=100?t.sample=n:delete t.sample}return t},delay:function(t,e){return -1===e?(t(),null):setTimeout(t,e||0)},ext:function(t){for(var e=1,n=arguments.length;e<n;e++){var r=arguments[e];for(var o in r){Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}}return t},sub:function(t,e){var n={};return this.each(t,function(t,r){-1!==e.indexOf(r)&&(n[r]=t)}),n},uu:function(){for(var t,e,n=20,r=new Array(n),o=Date.now().toString(36).split("");n-->0;){e=(t=36*Math.random()|0).toString(36),r[n]=t%3?e:e.toUpperCase()}for(var i=0;i<8;i++){r.splice(3*i+2,0,o[i])}return r.join("")},seq:function(){return(SEQUENCE++).toString(36)},decode:function(t){try{t=decodeURIComponent(t)}catch(e){}return t},encode:function(t,e){try{t=e?encodeURIComponent(t).replace(/\(/g,"%28").replace(/\)/g,"%29"):encodeURIComponent(t)}catch(n){}return t},serialize:function(t){t=t||{};var e=[];for(var n in t){Object.prototype.hasOwnProperty.call(t,n)&&t[n]!==undefined&&e.push(n+"="+this.encode(t[n],"msg"===n))}return e.join("&")},checkAPI:function(t,e){if(!t||"string"!=typeof t){return !1}var n=/openmonitor(\.(dev|sit|test))?\.alipay[\w-]*/.test(t);return !n&&e&&(n=/(\.png)|(\.gif)|(alicdn\.com)/.test(t)),!n},checkAutoError:function(t){return !(!t||!t.message)&&!/failed[\w\s]+fetch/i.test(t.message)},cutUrlSearch:function(t){return t&&"string"==typeof t?t.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},getRandIP:function(){for(var t=[],e=0;e<4;e++){var n=Math.floor(256*Math.random());t[e]=(n>15?"":"0")+n.toString(16)}return t.join("")},getSortNum:function(t){return t?(t+=1)>=1000&&t<=9999?t:t<1000?t+1000:t%10000+1000:1000},getRandNum:function(t){return t&&"string"==typeof t?t.length<5?this.getNum(5):t.substring(t.length-5):this.getNum(5)},getNum:function(t){for(var e=[],n=0;n<t;n++){var r=Math.floor(16*Math.random());e[n]=r.toString(16)}return e.join("")},isFunction:function(t){return"function"==typeof t},isPlainObject:function(t){return"[object Object]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"===Object.prototype.toString.call(t)},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},joinRegExp:function(t){for(var e,n=[],r=0,o=t.length;r<o;r++){e=t[r],this.isString(e)?n.push(e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")):e&&e.source&&n.push(e.source)}return new RegExp(n.join("|"),"i")},getValue:function(j,arr){for(var k in j){if(arr.indexOf(k)>-1){return j[k]}}return null},},util_1=util,pushToQueue=function(e,t){if("error"!==t.t){if("behavior"===t.t){var r=e.requestQueue&&e.requestQueue.length;if(r>0&&"behavior"===e.requestQueue[r-1].t){var s=t.behavior||[];e.requestQueue[r-1].behavior.concat(s)}else{e.requestQueue.push(t)}}else{e.requestQueue.unshift(t)}return e.onReady(function(){e.requestTimmer=util.delay(function(){e.clear()},e.requestQueue[0]&&"error"===e.requestQueue[0].t?3000:-1)}),!0}},Base=function(t){return this.ver="1.0.0",this._conf=util.ext({},Base.dftCon),this.requestQueue=[],this.hash=util.seq(),this.setConfig(t),this.rip=util.getRandIP(),this._common={},this};Base.dftCon={imgUrl:"https://openmonitor.alipay-eco.com/cloudmonitor/put.htm?",release:undefined,environment:"production",charset:"utf-8"},Base.prototype={constructor:Base,getPage:function(){var e=this._conf.page;return util.safetyCall(e,[],e+"")},setPage:function(){},setConfig:function(e){e&&"object"==typeof e&&(util.verifyConfig(e),e=this.setImgUrl(e),this._conf=util.ext({},this._conf,e))},setImgUrl:function(e){if(!!e.imgUrl){this._conf.imgUrl=e.imgUrl}return e},sendRequest:function(){},postData:function(){},commonInfo:function(){return{}},setCommonInfo:function(e){e&&"object"==typeof e&&(this._common=util.ext({},this._common,e))},getConfig:function(e){return e?this._conf[e]:util.ext({},this._conf)},clear:function(){var e;for(clearTimeout(this.requestTimmer),this.requestTimmer=null;e=this.requestQueue.pop();){"res"===e.t?this.postData(e,"res"):"error"===e.t?this.postData(e,"err"):"behavior"===e.t?this.postData(e,"behavior"):this.sendRequest(e)
}return this},_lg:function(e,t,i){var r=this._conf,s=this.getPage();return t&&!r.disabled&&r.token?(t=util.ext({t:e,page:s,environment:r.environment,_input_charset:r.charset,timestamp:Date.now()},t,this.commonInfo(),this._common,{token:r.token,_v:this.ver,}),pushToQueue(this,t)):this},custom:function(e,t){if(!e||"object"!=typeof e){return this}var i=!1,r={timestamp:Date.now()};return util.each(e,function(e,t){return !(i=t&&t.length<=20)&&util.warn("[retcode] invalid key: "+t),r["x-"+t]=e,i}),i?this._lg("custom",r,t||1):this},report:function(e){this.custom(e,1)}};var base=Base,validApiKeys=["api","success","time","code","msg","begin"],parseStatData=function(t,e){var r=t.split("::");return r.length>1?util_1.ext({group:r[0],key:r[1]},e):util_1.ext({group:"default_group",key:r[0]},e)},Reporter=function(t){base.call(this,t);var e;try{e="object"==typeof performance?performance.timing.fetchStart:Date.now()}catch(r){e=Date.now()}return this._startTime=e,this};Reporter.prototype=util_1.createObject(base.prototype),util_1.ext(base.dftCon,{startTime:null}),util_1.ext(Reporter.prototype,{constructor:Reporter,_super:base,sum:function(t,e,r){try{return this._lg("sum",parseStatData(t,{val:e||1,begin:Date.now()}),r)}catch(n){util_1.warn("[retcode] can not get parseStatData: "+n)}},avg:function(t,e,r){try{return this._lg("avg",parseStatData(t,{val:e||0,begin:Date.now()}),r)}catch(n){util_1.warn("[retcode] can not get parseStatData: "+n)}},percent:function(t,e,r,n){try{return this._lg("percent",parseStatData(t,{subkey:e,val:r||0,begin:Date.now()}),n)}catch(i){util_1.warn("[retcode] can not get parseStatData: "+i)}},msg:function(t,e){if(t&&!(t.length>180)){return this.custom({msg:t},e)}},error:function(t,e){if(!t){return util_1.warn("[cloudMonitor] invalid param e: "+t),this}1===arguments.length?("string"==typeof t&&(t={message:t},e={}),"object"==typeof t&&(e=t=t.error||t)):("string"==typeof t&&(t={message:t}),"object"!=typeof e&&(e={}));var r=t.name||"CustomError",n=util_1.encode(t.message),i=util_1.encode(t.stack||"");e=e||{};var o={begin:Date.now(),cate:r,msg:n.substring(0,1000),stack:i&&i.substring(0,1000),file:e.filename||"",line:e.lineno||"",col:e.colno||"",err:{msg_raw:n,stack_raw:i}};return this._lg("error",o,1)},behavior:function(t){if(t){var e="object"==typeof t&&t.behavior?t:{behavior:t};return this._lg("behavior",e,1)}},api:function(e,t,r,i,a,s){if(!e){return util.warn("[cloudMonitor] api is null"),this}e="string"==typeof e?{api:e,success:t,time:r,code:i,msg:a,begin:s}:util.sub(e,validApiKeys);if(e.code=e.code||"",e.msg=e.msg||"",e.success=e.success?1:0,e.time=+e.time,e.begin=e.begin||"",!e.api||isNaN(e.time)){return util.warn("[cloudMonitor] invalid time or api"),this}return this._lg("api",e,1)},resource:function(t,e){if(!t||!util_1.isPlainObject(t)){return util_1.warn("[cloudMonitor] invalid param data: "+t),this}var r=Object.keys(t),n=["begin","dom","load","res","dl"],i=!1;for(var o in n){if(r.indexOf(n[o])<0){i=!0;break}}if(i){return util_1.warn("[cloudMonitor] lack param data: "+t),this}var a={begin:t.begin||Date.now(),dom:t.dom||"",load:t.load||"",res:util_1.isArray(t.res)?JSON.stringify(t.res):JSON.stringify([]),dl:t.dl||""};return this._lg("res",a,e)}}),Reporter._super=base,Reporter._root=base,base.Reporter=Reporter;var reporter=Reporter,MiniProgramLogger=function(t){t&&t.token||util.warn("[cloudMonitor] token is a required prop to instatiate MiniProgramLogger");var o=this;return Reporter.call(o,t),"function"==typeof o.autoSetCommonInfo&&o.autoSetCommonInfo(),this};MiniProgramLogger.prototype=util.createObject(Reporter.prototype),util.ext(Reporter._root.dftCon,{sendRequest:function(){},getCurrentPage:function(){}}),util.ext(MiniProgramLogger.prototype,{constructor:MiniProgramLogger,_super:Reporter,onReady:function(e){e()},sendRequest:function(e,o){if(this.getConfig("debug")){"undefined"!=typeof console&&console&&"function"==typeof console.log&&console.log("[cloudMonitor] [DEBUG MODE] log data",e)}else{var t=this.getConfig("imgUrl");"object"==typeof e&&(e=util.serialize(e));var n=t+e;o&&(n+="&post_res=");var r=this._conf.sendRequest;if("function"==typeof r){try{r(n,o)}catch(i){util.warn("[cloudMonitor] error in sendRequest",i)}}}},postData:function(e,o){var t={};t[o]=e[o],delete e[o],this.sendRequest(e,t)},getPage:function(){var e=this._conf.getCurrentPage;if("function"==typeof e){try{var o=e();if(o&&"string"==typeof o){return o}}catch(t){util.warn("[cloudMonitor] error in getPage",t)}}return"string"==typeof e&&e?e:this.DEFAUT_PAGE_PATH},setConfig:function(e){if(e&&"object"==typeof e){util.verifyConfig(e),e=this.setImgUrl(e);var o=this._conf;this._conf=util.ext({},this._conf,e)}},autoSetCommonInfo:function(){this.setCommonInfo({app:"mini_common",uid:this._conf.uid})}});MiniProgramLogger.init=function(t){return new MiniProgramLogger(t||{})};MiniProgramLogger._super=reporter,MiniProgramLogger._root=reporter._root,reporter.MiniProgramLogger=MiniProgramLogger;var miniProgramLogger=MiniProgramLogger,STORAGE_MINIPROGRAM_ALIPAY_UID_KEY="STORAGE_MINIPROGRAM_ALIPAY_UID",AlipayLogger=function(t){return MiniProgramLogger.call(this,t),this
};AlipayLogger.prototype=util.createObject(MiniProgramLogger.prototype),util.ext(MiniProgramLogger._root.dftCon,{sendRequest:function(t,e){if("undefined"!=typeof my&&my&&"function"==typeof my.request){try{var o,r="GET";e&&(r="POST",o=JSON.stringify(e)),my.request({url:t,method:r,data:o,dataType:"json",fail:function(t){util.warn("[cloudMonitor] sendRequest fail",t)}})}catch(n){util.warn("[cloudMonitor] error in conf sendRequest",n)}}},getCurrentPage:function(){if("function"==typeof getCurrentPages){try{var t=getCurrentPages()||[],e=t[t.length-1];return e&&e.route||null}catch(o){util.warn("[cloudMonitor] error in conf getCurrentPage",o)}}}}),util.ext(AlipayLogger.prototype,{constructor:AlipayLogger,_super:MiniProgramLogger,autoSetCommonInfo:function(){this.setCommonInfo({app:"mini_alipay"}),this.autoSetNetworkType(),this.autoSetUid(),this.autoSystemInfo()},autoSetUid:function(){var t=this;if(t._conf&&t._conf.uid){t.setCommonInfo({uid:t._conf.uid})}else{if("undefined"!=typeof my&&my&&"function"==typeof my.getStorage){try{my.getStorage({key:STORAGE_MINIPROGRAM_ALIPAY_UID_KEY,success:function(e){if(e&&e.data&&"string"==typeof e.data){t.setCommonInfo({uid:e.data})}else{if("function"==typeof my.setStorage){var o=util.uu();my.setStorage({key:STORAGE_MINIPROGRAM_ALIPAY_UID_KEY,data:o,success:function(){t.setCommonInfo({uid:o})},fail:function(t){util.warn("[cloudMonitor] error in setStorage",t)}})}}},fail:function(t){util.warn("[cloudMonitor] error in getStorage",t)}})}catch(e){util.warn("[cloudMonitor] error in autoSetUid",e)}}}},autoSystemInfo:function(){var t=this;if("undefined"!=typeof my&&my&&"function"==typeof my.getSystemInfo){try{my.getSystemInfo({success:function(e){e&&"string"==typeof e.model&&"string"==typeof e.version&&"string"==typeof e.platform&&t.setCommonInfo({mobile:e.model,version:e.version,platform:e.platform,system:e.system})},fail:function(t){util.warn("[cloudMonitor] autoSystemInfo getSystemInfo fail",t)}})}catch(e){util.warn("[cloudMonitor] error in getSystemInfo",e)}}},autoSetNetworkType:function(){var t=this;if("undefined"!=typeof my&&my&&"function"==typeof my.getNetworkType){try{my.getNetworkType({success:function(e){e&&"string"==typeof e.networkType&&t.setCommonInfo({net:e.networkType})},fail:function(t){util.warn("[cloudMonitor] autoSetNetworkType getNetworkType fail",t)}})}catch(e){util.warn("[cloudMonitor] error in autoSetNetworkType",e)}}}});AlipayLogger.hookApi=function(p){if(!p||!p.token){util.warn("[cloudMonitor] not set token");return}var code=p.code||["stat","status","code","success"];var msg=p.msg||["msg","message","errorMessage"];var t=util,e=this.init(p);!this.isHookInstantiated&&(function(){if("undefined"!=typeof my&&my&&"function"==typeof my.request){var s=my.request;var a=Object.getOwnPropertyDescriptor(my,"request");a&&a.writable&&(my.request=function(i){var a=new Date().getTime(),n=i;if(i&&i.url){var o=t.cutUrlSearch(i.url);if(!t.checkAPI(o,!0)){return s.call(my,n)}var u=n&&n.headers;u&&"object"==typeof u||(u={});var p={success:function(t){"function"==typeof i.success&&i.success(t);var s=new Date().getTime(),c="",u="";if(t.data&&(!i.dataType||i.dataType==="json")){c=util.getValue(t.data,code)||"";u=util.getValue(t.data,msg)||""}e.api({api:o,success:!0,time:s-a,code:c,msg:u})},fail:function(t){"function"==typeof i.fail&&i.fail(t);var s=new Date().getTime(),n="";t&&t.status&&(n=t.status);n==""&&t.error&&(n=t.error);var u="";t&&t.body&&(u=(u=JSON.stringify(t.body)).substring(0,1000)),e.api({api:o,success:!1,time:s-a,code:n,msg:u})}};n=t.ext({},n,p)}return s.call(my,n)})}}.call(this),this.isHookInstantiated=!0)};AlipayLogger.init=function(t){return new AlipayLogger(t||{})};AlipayLogger._super=miniProgramLogger,AlipayLogger._root=miniProgramLogger._root,miniProgramLogger.AlipayLogger=AlipayLogger;var clazz=AlipayLogger;module.exports=clazz;


